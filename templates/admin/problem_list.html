<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <script src="{{ url_for('static', filename='js/Sortable/1.14.0/Sortable.min.js') }}"></script>
    <title>é¢˜åº“ç®¡ç†ç³»ç»Ÿ</title>
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <style>
        .borderedcontent {
            border: 1px solid black; /* è¾¹æ¡†é¢œè‰²å’Œç²—ç»† */
            display: inline-block; /* ç¡®ä¿è¾¹æ¡†åŒ…è£¹æ–‡æœ¬ */
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        .d-flex {
            display: flex;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .flex-fill {
            flex: 1;
        }

        .box {
            border: 2px solid #4CAF50;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #f9f9f9;
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        a {
            color: #4CAF50;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .highlighted {
            background-color: #39C5BB;
        }

        .large-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            font-size: 18px;
            margin-top: 20px;
            color: #4CAF50;
            /* è®¾ç½®é¢œè‰² */
            font-weight: bold;
            /* è®¾ç½®å­—ä½“åŠ ç²— */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            /* å›¾æ ‡å’Œæ–‡å­—ä¹‹é—´çš„é—´è· */
        }

        .loading::before {
            content: "";
            width: 24px;
            height: 24px;
            border: 3px solid #4CAF50;
            /* è®¾ç½®åŠ è½½åœ†åœˆé¢œè‰² */
            border-top-color: transparent;
            /* é¡¶éƒ¨è¾¹æ¡†é€æ˜ */
            border-radius: 50%;
            /* è®¾ç½®ä¸ºåœ†å½¢ */
            animation: spin 1s linear infinite;
            /* åŠ å…¥æ—‹è½¬åŠ¨ç”» */
        }

        /* æ—‹è½¬åŠ¨ç”» */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal-img {
            max-width: 100px;
            margin: auto;
        }

        .single-line {
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            max-width: 100px;
        }

        .preserve-spaces {
            white-space: pre-wrap;
        }

        #to-bottom-button,
        #to-top-button {
            width: 50px;
            height: 50px;
            text-align: center;
            line-height: 50px;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #333;
            text-decoration: none;
            font-size: 24px;
        }

        #to-bottom-button {
            position: fixed;
            right: 0px;
            top: 70px;
        }

        #to-top-button {
            position: fixed;
            right: 0px;
            bottom: 60px;
        }

        #fixedContainer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 1000;
            padding: 10px;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
            font-size: 16px;
        }

        #selectedQuestionTags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            /* æ ‡ç­¾é—´è· */
            max-width: 80%;
            /* é˜²æ­¢å æ»¡æ•´ä¸ªå®¹å™¨ */
            overflow: hidden;
        }

        .question-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-size: 14px;
            position: relative;
        }

        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            width: 800px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .question-tag button {
            margin-left: 5px;
            background: none;
            border: none;
            cursor: pointer;
            color: red;
        }


        .form-control {
            width: 90%;
            margin: auto;
        }

        .highlighted-content {
            overflow-x: auto;
            /* æ°´å¹³æ»šåŠ¨æ¡ï¼Œä¿æŒè¡¨æ ¼å®½åº¦ä¸€è‡´ */
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .border {
            margin-bottom: 10px;
        }

        /* è¾…åŠ©ä¿¡æ¯æ ·å¼ */
        .sub-info {
            font-size: 0.9em;
            color: #888888;
            margin-top: 3px;
            line-height: 1.4;
        }
        
        .prompt-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .prompt-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 600px;
            height: 320px;
            max-width: 90%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .prompt-textarea {
            height: 200px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .prompt-footer {
            text-align: right;
        }
    
        .action-btn {
            padding: 4px 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: transparent;
            color: #7f8c8d;
        }
        
        .edit-btn:hover {
            background: #fff3cd;
            border-color: #f39c12;
            color: #f39c12;
        }
        
        .delete-btn:hover {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #e74c3c;
        }
        
        .action-btn:hover {
            transform: none;
            box-shadow: none;
        }
    </style>
</head>

<body>

    {% extends 'header.html' %}
    {% block content %}

    <!-- è¾“å…¥é¢˜ç›®æ¸…å•çš„æ¨¡æ€æ¡†ï¼Œç”¨äºç”¨æˆ·è¾“å…¥è€ƒè¯•åç§°ã€æ—¶é•¿ã€é¢˜ç›®æ•°é‡ç­‰ä¿¡æ¯ -->
    <div class="modal fade" id="downloadModal" tabindex="-1" role="dialog" aria-labelledby="downloadModalLabel" style="margin-top:30px">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="downloadModalLabel">è¾“å…¥é¢˜ç›®æ¸…å•åç§°</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œè¾“å…¥é¢˜ç›®æ¸…å•çš„åç§°å’Œè€ƒè¯•çš„ç›¸å…³é…ç½® -->
                    <input type="text" class="form-control" id="listNameInput" placeholder="é¢˜ç›®æ¸…å•åç§°">
                    <input type="number" class="form-control" id="durationInput" placeholder="è€ƒè¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰">
                    <input type="number" class="form-control" id="numQuestionsInput" placeholder="é¢˜ç›®æ•°é‡">
                    <input type="number" class="form-control" id="scorePerQuestionInput" placeholder="æ¯é“é¢˜åˆ†æ•°">
                    <select class="form-control" id="classSelect" multiple>
                        <!-- åŠ¨æ€åŠ è½½ç­çº§é€‰é¡¹ -->
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="confirmDownload">ä¸‹è½½</button>
                    <button type="button" class="btn btn-info" id="create_exam">ç»„å·</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ï¼Œç”¨äºæ˜¾ç¤ºé¢˜ç›®çš„è¯¦ç»†ä¿¡æ¯ -->
    <div class="modal fade" id="questionDetailModal" tabindex="-1" aria-labelledby="questionDetailModalLabel" style="margin-top:30px">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="questionDetailModalLabel">é¢˜ç›®è¯¦æƒ…ï¼ˆæŒ‰ESCé€€å‡ºï¼‰</h5>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- æ¨¡æ€æ¡†ä¸­åŒ…å«é¢˜ç›®çš„å„ä¸ªå±æ€§ï¼Œå¦‚å†…å®¹ã€çŸ¥è¯†ç‚¹ã€æè¿°ã€éš¾åº¦ç­‰ -->
                    <p>
                        <strong>å†…å®¹ï¼š</strong>
                    <div class="highlighted-content-model"><span id="modalContent"></span></div>
                    </p>
                    <p><strong>çŸ¥è¯†ç‚¹ï¼š</strong>
                    <div class="border p-3 rounded bg-light">
                        <span id="modalKnowledgePoint"></span>
                    </div>
                    </p>
                    <p>
                        <strong>æè¿°ï¼š</strong> <!-- æ–°å¢æè¿°å­—æ®µ -->
                    <div class="border p-3 rounded bg-light">
                        <span id="modalDescription"></span>
                    </div>
                    </p>
                    <p>
                        <strong>éš¾æ˜“åº¦ï¼š</strong>
                    <div class="border p-3 rounded bg-light">
                        <span id="modalDifficulty"></span>
                    </div>
                    </p>
                    <p>
                        <strong>æ¥æºï¼š</strong>
                    <div class="border p-3 rounded bg-light">
                        <span id="modalSource"></span>
                    </div>
                    </p>
                    <p>
                        <strong>ç­”æ¡ˆï¼š</strong>
                    <div class="border p-3 rounded bg-light">
                        <span id="modalAnswer"></span>
                    </div>
                    </p>
                    <p>
                        <strong>è§£æï¼š</strong>
                    <div>
                        <span id="modalAnalysis"></span>
                    </div>
                    </p>
                    <p>
                        <strong>æ›´æ–°æ—¶é—´ï¼š</strong>
                    <div class="border p-3 rounded bg-light">
                        <span id="modalUpdatedAt"></span>
                    </div>
                    </p>
                    <p>
                        <strong>æ·»åŠ äººï¼š</strong>
                        <span id="modalAddedBy"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ï¼Œç”¨äºç¼–è¾‘é¢˜ç›® -->
    <div class="modal fade" id="editQuestionModal" tabindex="-1" aria-labelledby="editQuestionModalLabel" style="margin-top:30px">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editQuestionModalLabel">ä¿®æ”¹é¢˜ç›®</h5>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editQuestionForm">

                        <!-- ç¼–è¾‘è¡¨å•ï¼Œæäº¤æŒ‰é’®ä½äºé¡¶éƒ¨å’Œåº•éƒ¨ -->
                        <button type="submit" class="btn btn-primary mb-3">æäº¤ä¿®æ”¹</button>
                        
                        <div class="mb-3">
                            <label class="form-label">é¢˜ç›®ç±»å‹</label>
                            <div class="btn-group" role="group">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="qtype" id="qtype0" value="0" checked>
                                    <label class="form-check-label btn btn-outline-secondary" for="qtype0">å…¶ä»–</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="qtype" id="qtype1" value="1">
                                    <label class="form-check-label btn btn-outline-secondary" for="qtype1">é€‰æ‹©é¢˜</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="qtype" id="qtype2" value="2">
                                    <label class="form-check-label btn btn-outline-secondary" for="qtype2">ææ–™é¢˜</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="qtype" id="qtype3" value="3">
                                    <label class="form-check-label btn btn-outline-secondary" for="qtype3">ç»¼åˆé¢˜</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é¢˜ç›®å†…å®¹çš„ç¼–è¾‘åŒºï¼Œç”¨æˆ·å¯ä»¥è¾“å…¥å’Œç¼–è¾‘é¢˜ç›®æè¿° -->
                        <div class="mb-3">
                            <label for="editContent" class="form-label">å†…å®¹</label>
                            <button type="button" class="btn btn-warning" onclick="html_format('#editContent')">æ¸…é™¤æ ¼å¼</button>
                            <button type="button" class="btn btn-warning" onclick="choose_format('#editContent')">é€‰æ‹©é¢˜</button>
                            <textarea style="height:300px" class="form-control" id="editContent" rows="3"></textarea>
                        </div>

                        <!-- å…¶ä»–é¢˜ç›®å±æ€§ï¼Œå¦‚çŸ¥è¯†ç‚¹ã€éš¾æ˜“åº¦ã€æ¥æºã€ç­”æ¡ˆç­‰å­—æ®µ -->
                        <!-- ä¿®æ”¹çŸ¥è¯†ç‚¹ç¼–è¾‘åŒºï¼šä½¿ç”¨æ ‡ç­¾æ–¹å¼é€‰æ‹©ï¼Œéšè—å­˜å‚¨æœ€ç»ˆç»“æœ -->
                        <div class="mb-3">
                            <label for="editKnowledgePointHidden" class="form-label">çŸ¥è¯†ç‚¹</label>
                            <div id="edit-knowledge-points"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editDifficulty" class="form-label">éš¾æ˜“åº¦</label>
                            <input type="number" class="form-control" id="editDifficulty">
                        </div>
                        <div class="mb-3">
                            <label for="editSource" class="form-label">æ¥æº</label>
                            <input type="text" class="form-control" id="editSource">
                        </div>
                        <div class="mb-3">
                            <label for="editAnswer" class="form-label">ç­”æ¡ˆ</label>
                            <textarea type="text" class="form-control" id="editAnswer" style="height: 100px"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editAnalysis" class="form-label">è§£æ</label>
                            <div class="d-flex align-items-center mb-3">
                                <select id="analysisMode" style="width: 150px;"><option value="chatgpt4omini">chatgpt-4o-mini</option>
                                    <option value="chatgpt3.5">chatgpt-3.5</option>
                                    <option value="deepseekv3">DeepSeek V3</option>
                                    <option value="deepseekr1">DeepSeek R1ï¼ˆææ…¢ï¼‰</option>
                                    <option value="baidu">æ–‡å¿ƒä¸€è¨€ 4.0</option>
                                    <option value="chatgpt4o">chatgpt-4o</option>
                                    <option value="chatgpt4">chatgpt-4</option>
                                    <option value="chatgpto1mini">chatgpt-o1-mini</option>
                                    <option value="chatgpto1">chatgpt-o1</option>
                                    <option value="chatgpto3mini">chatgpt-o3-mini</option>
                                    <option value="chatgpt4.5">chatgpt-4.5</option>
                                </select>
                                <button type="button" class="btn btn-warning btn-sm" onclick="generateAnalysis('editContent', 'editAnswer', '#editAnalysis')">ç”Ÿæˆè§£æ</button>
                                 <button type="button" class="btn btn-outline-secondary btn-sm" onclick="togglePromptBox()">è‡ªå®šä¹‰Prompt</button>ï¼ˆæš‚ä¸æ”¯æŒå›¾ç‰‡è¯†åˆ«ï¼‰
                            </div>
                            <!-- æ·»åŠ æ‚¬æµ®æ¡† -->
                            <div id="promptOverlay" class="prompt-overlay">
                                <div class="prompt-box">
                                    <div class="prompt-header">
                                        <h5>è‡ªå®šä¹‰è§£ææç¤ºè¯</h5>
                                        <button type="button" class="btn-close" onclick="togglePromptBox()"></button>
                                    </div>
                                    <textarea id="customPrompt" class="form-control prompt-textarea">è¯·ä½ æ ¹æ®é¢˜ç›®å’Œç­”æ¡ˆç”ŸæˆHTMLæ ¼å¼çš„è§£æï¼Œè¿”å›ç»“æœæ—¶ä¸éœ€è¦åŠ ä»»ä½•çš„æç¤ºè¯­ï¼Œä»¥â€œã€è§£æ(GPT)ã€‘â€å¼€å¤´ï¼Œæ³¨æ„ä»¥å†…è”å½¢å¼è®¾ç½®styleæ ·å¼ï¼Œä¸è¦ç”¨cssç±»ã€‚ä¸ºäº†èŠ‚çœtokenï¼Œè¯·è®©HTMLè¯­å¥å°½é‡æ¸…æ™°ç²¾ç®€ï¼Œä¸å¿…è®¾ç½®è¿‡å¤šçš„æ ·å¼ï¼Œå¯¹äºç»“æ„åŒ–çš„æ­¥éª¤å¯ç”¨è¡¨æ ¼å±•ç¤ºã€‚ä»¥ä¸‹æ˜¯é¢˜ç›®å’Œç­”æ¡ˆã€‚</textarea>
                                    <div class="prompt-footer">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="togglePromptBox()">ç¡®è®¤</button>
                                    </div>
                                </div>
                            </div>
                            <textarea style="height:300px" class="form-control" id="editAnalysis" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">æè¿°</label>
                            <textarea type="text" class="form-control" id="editDescription"></textarea>
                        </div>

                        <!-- åº•éƒ¨æäº¤æŒ‰é’® -->
                        <button type="submit" class="btn btn-primary">æäº¤ä¿®æ”¹</button>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <!-- é¡µé¢ä¸»ä½“éƒ¨åˆ†ï¼ŒåŒ…æ‹¬æœç´¢æ¡ä»¶å’Œåˆ†é¡µæŒ‰é’® -->
    <div>
        <!-- é¡µé¢é¡¶éƒ¨çš„é”šç‚¹ï¼Œç”¨äºå¿«é€Ÿå®šä½åˆ°é¡µé¢é¡¶éƒ¨ -->
        <div id="top-of-page" style="height: 0;"></div>

        <!-- é¢˜ç›®æœç´¢æ¡†å’Œè¿‡æ»¤å™¨ï¼ŒåŒ…æ‹¬å…³é”®å­—ã€çŸ¥è¯†ç‚¹ã€éš¾æ˜“åº¦ç­‰æ¡ä»¶ -->
        <div class="card mb-4">
            <div class="card-header text-white bg-primary">
                <h5 class="mb-0">ç­›é€‰æ¡ä»¶</h5>
            </div>
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <!-- å…³é”®å­— -->
                    <div class="col-md-6">
                        <label for="keyword" class="form-label">å…³é”®å­—</label>
                        <input type="text" class="form-control" id="keyword" placeholder="è¯·è¾“å…¥å…³é”®å­—">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="exactMatchSwitch">
                            <label class="form-check-label" for="exactMatchSwitch">ç²¾ç¡®æŸ¥è¯¢</label>
                            <a href="javascript:void(0);" onclick="openPopup(1)" style="font-size: smaller; color: blue;">è¯´æ˜</a>
                        </div>
                    </div>
        
                    <!-- é¢˜ç›®ID -->
                    <div class="col-md-6">
                        <label for="question_id" class="form-label">é¢˜ç›®ID</label>
                        </label><a href="javascript:void(0);" onclick="openPopup(2)" style="font-size: smaller; color: blue;">è¯´æ˜</a>
                        <input type="text" class="form-control" id="question_id" placeholder="è¯·è¾“å…¥é¢˜ç›®ID">
                    </div>
        
                    <!-- çŸ¥è¯†ç‚¹ -->
                    <div class="col-md-12">
                        <label for="knowledge-points" class="form-label">çŸ¥è¯†ç‚¹</label>
                        <div id="knowledge-points">
                            <!-- çŸ¥è¯†ç‚¹åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <input type="hidden" id="knowledgePoint" name="knowledge_point">
                    </div>
        
                    <!-- éš¾æ˜“åº¦ -->
                    <div class="col-md-6">
                        <label for="difficulty" class="form-label">éš¾æ˜“åº¦</label>
                        <label for="keyword" class="form-label">å…³é”®å­—</label><a href="javascript:void(0);" onclick="openPopup(0)" style="font-size: smaller; color: blue;">è¯´æ˜</a>
                        <select class="form-select" id="difficulty">
                            <option value="" selected>é€‰æ‹©éš¾æ˜“åº¦</option>
                            <option value="1">1 - ç®€å•</option>
                            <option value="2">2 - è¾ƒç®€å•</option>
                            <option value="3">3 - ä¸­ç­‰</option>
                            <option value="4">4 - è¾ƒéš¾</option>
                            <option value="5">5 - å›°éš¾</option>
                        </select>
                    </div>
        
                    <!-- æ¥æº -->
                    <div class="col-md-6">
                        <label for="source" class="form-label">æ¥æº</label>
                        <input type="text" class="form-control" id="source" placeholder="è¯·è¾“å…¥æ¥æº">
                    </div>
        
                    <!-- ç±»å‹ -->
                    <div class="col-md-12">
                        <label class="form-label">é¢˜ç›®ç±»å‹</label>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="choiceOnlySwitch">
                                <label class="form-check-label" for="choiceOnlySwitch">é€‰æ‹©é¢˜</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="choiceMultiSwitch">
                                <label class="form-check-label" for="choiceMultiSwitch">ææ–™é¢˜</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="fillBlankSwitch">
                                <label class="form-check-label" for="fillBlankSwitch">ç»¼åˆé¢˜</label>
                            </div>
                        </div>
                    </div>
        
                    <!-- æˆ‘çš„é¢˜ç›® -->
                    <div class="col-md-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="myQuestionsSwitch">
                            <label class="form-check-label" for="myQuestionsSwitch">æˆ‘çš„é¢˜ç›®</label>
                        </div>
                    </div>
        
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="col-12 text-center">
                        <button type="button" class="btn btn-primary me-2" onclick="filterQuestions()">æŸ¥è¯¢</button>
                        <button type="button" class="btn btn-danger" onclick="reloadPage()">é‡ç½®</button>
                    </div>
                </form>
            </div>
        </div>
        <br>

        <!-- å›ºå®šåœ¨é¡µé¢åº•éƒ¨çš„è¾“å…¥æ¡†å’Œæ“ä½œæŒ‰é’®ï¼Œç”¨äºæŸ¥çœ‹å’Œä¸‹è½½é€‰ä¸­çš„é¢˜ç›® -->
        <div id="fixedContainer">
            <span>å·²é€‰é¢˜ç›®ï¼š</span>
            <div id="selectedQuestionTags"></div>
        
            <div>
                <!-- ä»…ç®¡ç†å‘˜/è€å¸ˆæ˜¾ç¤º ä¸‹è½½/ç»„å· å’Œ æ‰¹é‡åˆ é™¤ æŒ‰é’® -->
                <button class="btn btn-warning" id="downloadBtn" style="display: {{ 'inline-block' if is_admin_or_teacher else 'none' }}">
                    ä¸‹è½½/ç»„å·
                </button>
                <button class="btn btn-danger" id="batchDeleteBtn" style="display: {{ 'inline-block' if is_admin_or_teacher else 'none' }}">
                    æ‰¹é‡åˆ é™¤
                </button>
            </div>
        </div>



        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <button id="firstPage" class="btn btn-secondary">é¦–é¡µ</button>
                <button id="prevPage" class="btn btn-secondary">ä¸Šä¸€é¡µ</button>
                <span id="pageInfo"></span>
                <button id="nextPage" class="btn btn-secondary">ä¸‹ä¸€é¡µ</button>
                <button id="lastPage" class="btn btn-secondary">æœ«é¡µ</button>
                <input type="number" id="pageInput" min="1" style="width: 60px;" placeholder="é¡µç ">
                <button id="goToPage" class="btn btn-primary">è·³è½¬</button>
                <text id="resultCount"></text>
            </div>
            <a href="/add_question" class="btn btn-warning">æ·»åŠ é¢˜ç›®</a>
        </div>

        <!-- é¢˜ç›®è¡¨æ ¼ï¼Œæ˜¾ç¤ºé¢˜ç›®çš„IDã€å†…å®¹ã€çŸ¥è¯†ç‚¹ã€éš¾æ˜“åº¦ç­‰ä¿¡æ¯ -->
        <table class="table mt-3">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAllCheckbox" class="large-checkbox"></th>
                    <th>ID</th>
                    <th>é¢˜é¢</th>
                </tr>
            </thead>
            <tbody id="questionsTable">
                <tr></tr>
            </tbody>
        </table>

        <!-- åˆ†é¡µå¯¼èˆªï¼ˆåº•éƒ¨ï¼‰ -->
        <div>
            <button id="firstPageBottom" class="btn btn-secondary">é¦–é¡µ</button>
            <button id="prevPageBottom" class="btn btn-secondary">ä¸Šä¸€é¡µ</button>
            <span id="pageInfoBottom"></span>
            <button id="nextPageBottom" class="btn btn-secondary">ä¸‹ä¸€é¡µ</button>
            <button id="lastPageBottom" class="btn btn-secondary">æœ«é¡µ</button>
            <input type="number" id="pageInputBottom" min="1" style="width: 60px;" placeholder="é¡µç ">
            <button id="goToPageBottom" class="btn btn-primary">è·³è½¬</button>
            <text id="resultCountBottom"></text>
        </div>
        <div style="height: 60px;"></div>

    </div>

    <!-- é¡µé¢åº•éƒ¨çš„é”šç‚¹ -->
    <div id="bottom-of-page"></div>
    <a href="#bottom-of-page" id="to-bottom-button">â¬‡ï¸</a>
    <a href="#top-of-page" id="to-top-button">â¬†ï¸</a>

    <script>
        const isAdminOrTeacher = {{ 'true' if is_admin_or_teacher else 'false' }}; //æ˜¯å¦ç®¡ç†å‘˜
        let questions = []; //é—®é¢˜é›†
        let selectedQuestionOrder = []; //è®°å½•åŸå§‹çš„é¢˜å·IDï¼Œé¿å…åœ¨ä¸‹è½½æ—¶é¡ºåºæ··ä¹±
        let highlightedRowId = null; //é«˜äº®
        let currentPage = 1; //å½“å‰é¡µï¼Œèµ·å§‹ä¸º1
        const perPage = 50; //é»˜è®¤æ¯é¡µ50æ¡
        let originalQuestionData = {};

        let currentFilters = {}; //ç”¨æˆ·å½“å‰çš„è¿‡æ»¤æ¡ä»¶
        
        // é¡µé¢åŠ è½½åæ‰§è¡Œçš„åˆå§‹åŒ–æ“ä½œ
        document.addEventListener('DOMContentLoaded', () => {


            loadQuestions(currentPage, currentFilters); //åŠ è½½å¹¶æ˜¾ç¤ºç¬¬ä¸€é¡µé¢˜ç›®

            // é¡¶éƒ¨åˆ†é¡µæŒ‰é’®
            // â€œä¸‹ä¸€é¡µâ€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('nextPage').addEventListener('click', () => {
                currentPage += 1;
                loadQuestions(currentPage, currentFilters);
            });
            //ä¸Šä¸€é¡µ
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage -= 1;
                    loadQuestions(currentPage, currentFilters);
                }
            });
            //é¦–é¡µ
            document.getElementById('firstPage').addEventListener('click', () => {
                currentPage = 1;
                loadQuestions(currentPage, currentFilters);
            });
            //å°¾é¡µ
            document.getElementById('lastPage').addEventListener('click', () => {
                currentPage = totalPages; // å‡è®¾ totalPages æ˜¯æ‚¨åœ¨ loadQuestions æ–¹æ³•ä¸­è·å¾—çš„æ€»é¡µæ•°
                loadQuestions(currentPage, currentFilters);
            });
            //è·³è½¬
            document.getElementById('goToPage').addEventListener('click', () => {
                const pageInput = parseInt(document.getElementById('pageInput').value);
                if (!isNaN(pageInput) && pageInput >= 1 && pageInput <= totalPages) {
                    currentPage = pageInput;
                    loadQuestions(currentPage, currentFilters);
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ');
                }
            });
            // åº•éƒ¨åˆ†é¡µæŒ‰é’®ï¼ŒåŒä¸Š
            document.getElementById('nextPageBottom').addEventListener('click', () => {
                currentPage += 1;
                loadQuestions(currentPage, currentFilters);

            });
            document.getElementById('prevPageBottom').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage -= 1;
                    loadQuestions(currentPage, currentFilters);
                }
            });
            document.getElementById('firstPageBottom').addEventListener('click', () => {
                currentPage = 1;
                loadQuestions(currentPage, currentFilters);
            });
            document.getElementById('lastPageBottom').addEventListener('click', () => {
                currentPage = totalPages; // å‡è®¾ totalPages æ˜¯æ‚¨åœ¨ loadQuestions æ–¹æ³•ä¸­è·å¾—çš„æ€»é¡µæ•°
                loadQuestions(currentPage, currentFilters);
            });
            document.getElementById('goToPageBottom').addEventListener('click', () => {
                const pageInput = parseInt(document.getElementById('pageInputBottom').value);
                if (!isNaN(pageInput) && pageInput >= 1 && pageInput <= totalPages) {
                    currentPage = pageInput;
                    loadQuestions(currentPage, currentFilters);
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ');
                }
            });

        });

        //åŠ è½½é¢˜ç›®å¹¶ä¸”åˆ†é¡µæ˜¾ç¤º
        function loadQuestions(page, filters = {}) {
            //ç»™ä¸€ä¸ªé»˜è®¤å€¼é˜²æ­¢æŠ¥é”™
            const {
                keyword = '', knowledgePoint = '', difficulty = '', source = '', exactMatch = false, choiceOnly = false, choiceMulti = false, fillBlank = false, my_questions = false, question_id= ''
            } = filters;

            //æ˜¾ç¤ºåŠ è½½æç¤º
            document.getElementById('questionsTable').innerHTML = '<tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>';
            document.getElementById('resultCount').innerText = '';

            //å‘é€è¯·æ±‚æ•°æ®
            fetch(`/api/questions?page=${page}&per_page=${perPage}&keyword=${keyword}&knowledge_point=${knowledgePoint}&difficulty=${difficulty}&source=${source}&exact_match=${exactMatch}&choice_only=${choiceOnly}&choice_multi=${choiceMulti}&fill_blank=${fillBlank}&my_questions=${my_questions}&question_id=${question_id}`).then(response => response.json()).then(data => {
                questions = data.questions;

                //æ ‡è®°å·²é€‰æ‹©çš„é¢˜ç›®
                questions.forEach(question => {
                    question.selected = selectedQuestionOrder.includes(question.id);
                });
                //é‡æ–°æ¸²æŸ“
                renderQuestions(questions);
                //æ›´æ–°åˆ†é¡µæ§ä»¶
                updatePagination(data.current_page, data.total_pages);
                //æ˜¾ç¤ºæ€»é¢˜é‡
                document.getElementById('resultCount').innerText = `å…±${data.result_total}é¢˜`;

            }).catch(error => console.error('Error loading questions:', error));
        }
        //æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination(current, total) {
            totalPages = total; // è®¾ç½®æ€»é¡µæ•°ï¼Œä»¥ä¾¿å…¶ä»–åœ°æ–¹ä½¿ç”¨
            document.getElementById('pageInfo').innerText = `ç¬¬ ${current} é¡µ / å…± ${total} é¡µ`;
            document.getElementById('pageInfoBottom').innerText = `ç¬¬ ${current} é¡µ / å…± ${total} é¡µ`;
            document.getElementById('prevPage').disabled = current === 1;
            document.getElementById('nextPage').disabled = current === total;
            document.getElementById('prevPageBottom').disabled = current === 1;
            document.getElementById('nextPageBottom').disabled = current === total;
            document.getElementById('firstPage').disabled = current === 1;
            document.getElementById('lastPage').disabled = current === total;
            document.getElementById('firstPageBottom').disabled = current === 1;
            document.getElementById('lastPageBottom').disabled = current === total;
        }
        //æ¸²æŸ“é¢˜ç›®è¡¨æ ¼
        function renderQuestions(cur_questions) {
            const tableBody = document.getElementById('questionsTable');
            tableBody.innerHTML = '';

            //éå†æ‰€æœ‰é¢˜ç›®å¹¶ç”ŸæˆHTMLè¡Œ
            let rowsHtml = cur_questions.map((q, index) => {
                if (Object.keys(q).length === 0) {
                    return '';
                }
                const isChecked = q.selected ? 'checked' : ''; //æ£€æµ‹æ˜¯å¦è¢«é€‰ä¸­
                // å¤„ç†çŸ¥è¯†ç‚¹ï¼ŒæŒ‰ "|" åˆ†å‰²åæ¢è¡Œæ˜¾ç¤º
                const knowledgePointsHtml = q.knowledge_point.split('|').map(kp => `${kp.trim()} `).join('');
                // åŠ ä¸€ä¸ª isAdminOrTeacher æ¡ä»¶
                const detailTdHtml = isAdminOrTeacher 
                    ? `onclick="showQuestionDetail(${q.id})" style="cursor: pointer;"` 
                    : '';  // å¦åˆ™ä¸ç»™ onclick
                const actionButtons = isAdminOrTeacher
                ? `
                    <br>
                    <button class="action-btn edit-btn" onclick="showEditQuestionModal(${q.id})">âœï¸</button><br><br>
                    <button class="action-btn delete-btn" onclick="deleteQuestion('${q.id}')">ğŸ—‘</button>
                  `
                : ''; // å¦‚æœä¸æ˜¯ç®¡ç†å‘˜/è€å¸ˆï¼Œç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œä¸æ˜¾ç¤ºæŒ‰é’®
                const row = `
                <tr>
                    <td><input type="checkbox" class="question-checkbox large-checkbox" data-index="${index}" ${isChecked}></td>
                    <td class="single-line" for=>${q.id}</td>
                    <td ${detailTdHtml}>
                        <div class="sub-info">
                            çŸ¥è¯†ç‚¹ï¼š${knowledgePointsHtml} | éš¾åº¦ï¼š${q.difficulty} | å·²åšï¼š${q.attempts} | æ­£ç¡®ç‡ï¼š${q.percentage}% | æ¥æºï¼š${q.source} | è§£æï¼š${q.analysis?'âˆš':'Ã—'}  | æ·»åŠ äºº: ${q.added_by}
                        </div>
                        <div class="highlighted-content">${q.content}</div>
                    </td>
                    <td>
                        ${actionButtons}
                    </td>
                </tr>`;
                return row;
            }).join('');
            tableBody.innerHTML = rowsHtml; //å°†æ¯ä¸€è¡Œæ’å…¥è¡¨æ ¼

            // â€œå…¨é€‰â€å¤é€‰æ¡†çš„äº‹ä»¶å¤„ç†
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            // å…ˆç§»é™¤æ—§çš„äº‹ä»¶å¤„ç†ç¨‹åºä»¥é¿å…é‡å¤ç»‘å®š
            selectAllCheckbox.removeEventListener('change', handleSelectAllChange);
            // å†æ·»åŠ æ–°çš„äº‹ä»¶å¤„ç†ç¨‹åº
            selectAllCheckbox.addEventListener('change', handleSelectAllChange);
        }
        //å•ä¸ªå¤é€‰æ¡†çš„äº‹ä»¶å§”æ‰˜
        document.getElementById('questionsTable').addEventListener('change', function(event) {
            if (event.target.classList.contains('question-checkbox')) {
                const index = event.target.getAttribute('data-index');
                const questionId = questions[index].id;
                if (event.target.checked) {
                    if (!selectedQuestionOrder.includes(questionId)) {
                        selectedQuestionOrder.push(questionId);
                    }
                } else {
                    selectedQuestionOrder = selectedQuestionOrder.filter(id => id !== questionId);
                }
                updateSelectedQuestionIds();
            }
        });

        //â€œå…¨é€‰â€å¤é€‰æ¡†çš„äº‹ä»¶å¤„ç†å‡½æ•°
        function handleSelectAllChange() {
            const isChecked = this.checked;

            document.querySelectorAll('.question-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
                const index = checkbox.getAttribute('data-index');
                const questionId = questions[index].id;

                if (isChecked) {
                    if (!selectedQuestionOrder.includes(questionId)) {
                        selectedQuestionOrder.push(questionId);
                    }
                    questions[index].selected = true;
                } else {
                    selectedQuestionOrder = selectedQuestionOrder.filter(id => id !== questionId);
                    questions[index].selected = false;
                }
            });
            updateSelectedQuestionIds();
        }

        let tooltip; // æ‚¬æµ®çª—å…ƒç´ ï¼Œåªåˆ›å»ºä¸€ä¸ªå®ä¾‹
        let tooltipTimeout; // ç”¨äºæ§åˆ¶æ‚¬æµ®çª—æ˜¾ç¤ºçš„å»¶è¿Ÿ

        // æ›´æ–°é€‰ä¸­é¢˜ç›®çš„IDåˆ°é¡µé¢ä¸­çš„æ ‡ç­¾å®¹å™¨
        function updateSelectedQuestionIds() {
            const selectedQuestionTagsContainer = document.getElementById('selectedQuestionTags');
            selectedQuestionTagsContainer.innerHTML = '';

            selectedQuestionOrder.forEach(id => {
                const tag = document.createElement('div');
                tag.className = 'question-tag';
                tag.draggable = true; // è®¾ç½®æ ‡ç­¾ä¸ºå¯æ‹–åŠ¨

                const tagText = document.createElement('span');
                tagText.textContent = id;

                tag.onmouseenter = async function(event) {
                    clearTimeout(tooltipTimeout);

                    if (!tooltip) {
                        tooltip = document.createElement('div');
                        tooltip.className = 'tooltip';
                        document.body.appendChild(tooltip);
                    }

                    tooltip.style.display = 'block';

                    try {
                        const response = await fetch(`/api/questions/${id}`);
                        if (response.ok) {
                            const questionData = await response.json();
                            tooltip.innerHTML = `
                                <strong>å†…å®¹ï¼š</strong> ${questionData.content}<br>
                                <strong>çŸ¥è¯†ç‚¹ï¼š</strong> ${questionData.knowledge_point || 'æ— '}<br>
                                <strong>éš¾åº¦ï¼š</strong> ${questionData.difficulty || 'æ— '}<br>
                                <strong>æ¥æºï¼š</strong> ${questionData.source || 'æ— '}
                            `;
                        } else {
                            tooltip.textContent = 'æ— æ³•åŠ è½½é¢˜ç›®ä¿¡æ¯';
                        }
                    } catch (error) {
                        tooltip.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                    }

                    const windowHeight = window.innerHeight;
                    const tooltipHeight = tooltip.offsetHeight || 100;

                    tooltip.style.top = event.clientY + tooltipHeight + 20 > windowHeight ?
                        `${event.pageY - tooltipHeight - 10}px` :
                        `${event.pageY + 10}px`;
                    tooltip.style.left = `${event.pageX + 10}px`;
                    tooltip.style.opacity = '1';
                };

                tag.onmouseleave = function() {
                    if (tooltip) {
                        tooltip.style.opacity = '0';
                        tooltipTimeout = setTimeout(() => {
                            tooltip.style.display = 'none';
                        }, 300);
                    }
                };

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'âœ•';
                deleteButton.onclick = function() {
                    selectedQuestionOrder = selectedQuestionOrder.filter(questionId => questionId !== id);
                    //document.querySelector(`.question-checkbox[data-index="${questions.findIndex(q => q.id === id)}"]`).checked = false;
                    updateSelectedQuestionIds();
                };

                tag.appendChild(tagText);
                tag.appendChild(deleteButton);
                selectedQuestionTagsContainer.appendChild(tag);
            });

            // ä½¿ç”¨ Sortable ä½¿æ ‡ç­¾å®¹å™¨æ”¯æŒæ‹–æ‹½æ’åº
            Sortable.create(selectedQuestionTagsContainer, {
                animation: 150,
                onEnd: function(event) {
                    const reorderedTags = Array.from(selectedQuestionTagsContainer.children);
                    selectedQuestionOrder = reorderedTags.map(tag => Number(tag.querySelector('span').textContent));

                    // åŒæ­¥æ›´æ–°åˆ° questions æ•°ç»„çš„ selected çŠ¶æ€
                    questions.forEach(q => {
                        q.selected = selectedQuestionOrder.includes(q.id);
                    });

                    updateSelectedQuestionIds(); // æ›´æ–°é¡ºåºå’ŒçŠ¶æ€
                }
            });

            // åŒæ­¥é€‰ä¸­çŠ¶æ€åˆ°é—®é¢˜åˆ—è¡¨å¤é€‰æ¡†
            document.querySelectorAll('.question-checkbox').forEach((checkbox, index) => {
                const questionId = questions[index].id;
                checkbox.checked = selectedQuestionOrder.includes(questionId);
            });
        }



        // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„è¿‡æ»¤æ¡ä»¶é‡æ–°åŠ è½½é¢˜ç›®
        function filterQuestions() {
            const keyword = document.getElementById('keyword').value.trim();
            const question_id = document.getElementById('question_id').value.trim();
            const knowledgePoint = document.getElementById('knowledgePoint').value.toLowerCase();
            const difficulty = document.getElementById('difficulty').value;
            const source = document.getElementById('source').value.toLowerCase();
            const exactMatch = document.getElementById('exactMatchSwitch').checked;
            const choiceOnly = document.getElementById('choiceOnlySwitch').checked;
            const choiceMulti = document.getElementById('choiceMultiSwitch').checked;
            const fillBlank = document.getElementById('fillBlankSwitch').checked;
            const myQuestions = document.getElementById('myQuestionsSwitch').checked;
            currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            currentFilters = {
                keyword,
                knowledgePoint,
                difficulty,
                source,
                exactMatch,
                choiceOnly,
                choiceMulti,
                fillBlank,
                my_questions: myQuestions,
                question_id
            };
            loadQuestions(currentPage, currentFilters);
        }

        let editingQuestionId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„é¢˜ç›®ID

        // æ˜¾ç¤ºç¼–è¾‘é¢˜ç›®çš„æ¨¡æ€æ¡†
        function showEditQuestionModal(questionId) {
            editingQuestionId = questionId;
            const question = questions.find(q => q.id === questionId);

            // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºæ¯”è¾ƒ
            originalQuestionData = {
                content: question.content,
                knowledge_point: question.knowledge_point,
                difficulty: question.difficulty,
                source: question.source,
                answer: question.answer,
                analysis: question.analysis,
                description: question.description
            };


            // ä½¿ç”¨Summernoteç¼–è¾‘å†…å®¹å’Œè§£æ
            $('#editQuestionModal').on('shown.bs.modal', function() {
                $('#editContent').summernote('code', question.content);
                $('#editAnalysis').summernote('code', question.analysis);
            });
            // è°ƒç”¨æ–°å‡½æ•°åŠ è½½ç¼–è¾‘æ¨¡æ€æ¡†ä¸­çš„çŸ¥è¯†ç‚¹æ ‡ç­¾
            loadKnowledgePointsForEditModal();
            //document.getElementById('editknowledgePoint').value = question.knowledge_point;
            document.getElementById('editDifficulty').value = question.difficulty;
            document.getElementById('qtype' + question.qtype).checked = true;
            document.getElementById('editSource').value = question.source;
            document.getElementById('editAnswer').value = question.answer;
            document.getElementById('editDescription').value = question.description; // æ–°å¢æè¿°å­—æ®µ
            new bootstrap.Modal(document.getElementById('editQuestionModal')).show();
        }

        // å¤„ç†é¢˜ç›®ç¼–è¾‘è¡¨å•çš„æäº¤ï¼Œæ›´æ–°é¢˜ç›®ä¿¡æ¯
        document.getElementById('editQuestionForm').addEventListener('submit', function(event) {
            event.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤è¡Œä¸º
            const updatedQuestion = {
                content: document.getElementById('editContent').value,
                knowledge_point: document.getElementById('editKnowledgePointHidden').value,
                difficulty: Number(document.getElementById('editDifficulty').value),
                source: document.getElementById('editSource').value,
                // è·å–é€‰ä¸­çš„radioæŒ‰é’®çš„å€¼
                qtype: $('input[name="qtype"]:checked').val(),  // ç”¨ : è€Œä¸æ˜¯ =
                otherField: "value",
                answer: document.getElementById('editAnswer').value,
                analysis: document.getElementById('editAnalysis').value,
                description: document.getElementById('editDescription').value
            };
            // æ£€æŸ¥æ›´æ–°å‰å’Œæ›´æ–°åçš„æ•°æ®æ˜¯å¦ç›¸åŒ
            const isUpdated = Object.keys(updatedQuestion).some(key => updatedQuestion[key] !== originalQuestionData[key]);

            if (!isUpdated) {
                alert("æ— æ›´æ–°ï¼");
                return;
            }

            fetch(`/api/questions/${editingQuestionId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedQuestion)
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok');
            }).then(data => {
                const index = questions.findIndex(q => q.id === editingQuestionId);
                questions[index] = {
                    ...questions[index],
                    ...data,
                    selected: questions[index].selected
                };
                renderQuestions(questions);
                new bootstrap.Modal(document.getElementById('editQuestionModal')).hide();
                originalQuestionData = updatedQuestion;
                alert("æ›´æ–°æˆåŠŸï¼");
            }).catch(error => {
                console.error('æ›´æ–°å¤±è´¥:', error);
            });
        });
        // åˆ é™¤æŒ‡å®šIDçš„é¢˜ç›®
        function deleteQuestion(questionId) {
            if (confirm('ç¡®è®¤åˆ é™¤è¯¥é¢˜ç›®å—ï¼Ÿ')) {
                fetch(`/api/questions/${questionId}`, {
                    method: 'DELETE',
                }).then(response => response.json()).then(data => {
                    if (data.message) {
                        alert(data.message); // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæ¶ˆæ¯
                        // å†æ¬¡è·å–é—®é¢˜åˆ—è¡¨
                        return fetch('/api/questions');
                    } else if (data.error) {
                        alert(data.error); // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        return Promise.reject('Error: ' + data.error);
                    }
                }).then(response => response.json()).then(data => {
                    if (data.questions && Array.isArray(data.questions)) {
                        // æ›´æ–°å‰ç«¯é—®é¢˜åˆ—è¡¨
                        questions = data.questions;
                        renderQuestions(questions);
                    } else {
                        console.error('æ”¶åˆ°çš„åç«¯æ•°æ®æœªåŒ…å«questions:', data);
                    }
                }).catch(error => {
                    console.error('åˆ é™¤é”™è¯¯:', error);
                });
            }
        }
        // å°†UTCæ—¶é—´è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´
        function formatToLocalTime(utcDateString) {
            // å°† UTC æ—¶é—´å­—ç¬¦ä¸²è§£æä¸º Date å¯¹è±¡
            const utcDate = new Date(utcDateString);
            // åˆ›å»ºåç§»çš„æ—¶é—´ (UTC+8)
            const localDate = new Date(utcDate.getTime() - 8 * 60 * 60 * 1000);
            return localDate;
        }
        // å±•ç¤ºé¢˜ç›®è¯¦æƒ…ï¼Œå¡«å……æ¨¡æ€æ¡†å†…å®¹å¹¶æ˜¾ç¤º
        function showQuestionDetail(questionId) {
            const question = questions.find(q => q.id === questionId);
            document.getElementById('modalContent').innerHTML = question.content;
            document.getElementById('modalKnowledgePoint').innerText = question.knowledge_point;
            document.getElementById('modalDifficulty').innerText = question.difficulty;
            document.getElementById('modalSource').innerText = question.source;
            document.getElementById('modalAnswer').innerText = question.answer;
            document.getElementById('modalAnalysis').innerHTML = question.analysis;
            document.getElementById('modalDescription').innerText = question.description;
            // æ ¼å¼åŒ–æ›´æ–°æ—¶é—´ä¸ºä¸­æ–‡æ ¼å¼
            const updatedAt = formatToLocalTime(question.updated_at);
            const formattedUpdatedAt = new Intl.DateTimeFormat('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric'
            }).format(updatedAt);
            document.getElementById('modalUpdatedAt').innerText = formattedUpdatedAt;
            document.getElementById('modalAddedBy').innerText = question.added_by.join(', ');
            new bootstrap.Modal(document.getElementById('questionDetailModal')).show();
        }

        // ä¸‹è½½æŒ‰é’®äº‹ä»¶ï¼Œæ˜¾ç¤ºä¸‹è½½æ¨¡æ€æ¡†
        document.getElementById('downloadBtn').addEventListener('click', function() {
            $('#downloadModal').modal('show');
            loadClasses();
        });

        // åŠ è½½å¯é€‰æ‹©çš„ç­çº§æ•°æ®
        function loadClasses() {
            $.getJSON('/classes', function(data) {
                var classSelect = $('#classSelect');
                classSelect.empty();
                $.each(data, function(index, classItem) {
                    var option = $('<option></option>').attr('value', classItem.name).text(classItem.name);
                    classSelect.append(option);
                });
            });
        }

        // é¡µé¢åŠ è½½åï¼Œå¤„ç†ç»„å·åŠŸèƒ½
        $(document).ready(function() {
            $('#create_exam').on('click', function() {
                var listName = $('#listNameInput').val();
                var duration = $('#durationInput').val();
                var numQuestions = $('#numQuestionsInput').val();
                var scorePerQuestion = $('#scorePerQuestionInput').val();
                var selectedClasses = $('#classSelect').val();
                // æ£€æŸ¥æ‰€æœ‰å­—æ®µæ˜¯å¦å·²å¡«å†™
                if (!listName) {
                    alert("è¯·è¾“å…¥é¢˜ç›®æ¸…å•åç§°");
                    return;
                }
                if (!duration) {
                    alert("è¯·è¾“å…¥è€ƒè¯•æ—¶é•¿");
                    return;
                }
                if (!numQuestions) {
                    alert("è¯·è¾“å…¥é¢˜ç›®æ•°é‡");
                    return;
                }
                if (!scorePerQuestion) {
                    alert("è¯·è¾“å…¥æ¯é“é¢˜çš„åˆ†æ•°");
                    return;
                }
                if (!selectedClasses || selectedClasses.length === 0) {
                    alert("è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªç­çº§");
                    return;
                }
                var questionIds = selectedQuestionOrder
                $.ajax({
                    url: '/create_exam',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        name: listName,
                        question_ids: questionIds,
                        duration: duration,
                        num_questions: numQuestions,
                        score_per_question: scorePerQuestion,
                        classes: selectedClasses
                    }),
                    success: function(response) {
                        alert(response.message);
                        $('#downloadModal').modal('hide');
                    }
                });
            });
        });

        //ä¸‹è½½é¢˜ç›®
        document.getElementById('confirmDownload').addEventListener('click', function() {
            let listName = document.getElementById('listNameInput').value.trim();
            if (!listName) {
                listName = "";
            }
            const questionIds = selectedQuestionOrder;
    
            fetch('/generate_html', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question_ids: questionIds,
                    list_name: listName
                }),
            })
            .then(response => response.text())
            .then(htmlContent => {
                // å°† HTML å†…å®¹æ’å…¥åˆ°ä¸€ä¸ªéšè—çš„ div ä¸­
                const container = document.createElement('div');
                container.innerHTML = htmlContent;
                document.body.appendChild(container);
    
                // è½¬æ¢é¡µé¢ä¸­çš„å›¾ç‰‡ä¸º Base64
                const images = container.querySelectorAll('img');
                let imagePromises = [];
                images.forEach(img => {
                    imagePromises.push(convertImageToBase64(img));
                });
    
                // ç­‰å¾…æ‰€æœ‰å›¾ç‰‡è½¬æ¢å®Œæˆåå†å¯¼å‡º
                Promise.all(imagePromises).then(() => {
                    $(container).wordExport('questions');
                    document.body.removeChild(container); // ç§»é™¤ä¸´æ—¶å®¹å™¨
                });
            })
            .catch(error => {
                console.error('Download error:', error);
                alert('ä¸‹è½½å‡ºé”™ï¼Œè¯·ç¨åå†è¯•ï¼');
            });
        });
    
        // å›¾ç‰‡è½¬ Base64 çš„å‡½æ•°ï¼Œè¿”å› Promise ç¡®ä¿è½¬æ¢å®Œæˆ
        function convertImageToBase64(imgElement) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.src = imgElement.src;

                img.onload = function () {
                    const canvas = document.createElement("canvas");
                    // ä½¿ç”¨ imgElement çš„å®½é«˜æ¥è°ƒæ•´å¯¼å‡ºå¤§å°
                    canvas.width = imgElement.width;
                    canvas.height = imgElement.height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, imgElement.width, imgElement.height);
        
                    imgElement.src = canvas.toDataURL("image/png");
                    imgElement.style.width = `${imgElement.width}px`;
                    imgElement.style.height = `${imgElement.height}px`;
                    resolve(); // å®Œæˆè½¬æ¢
                };
    
                img.onerror = reject;
            });
        }
        // åˆ·æ–°é¡µé¢
        function reloadPage() {
            location.reload();
        }

        // é¡µé¢è·³è½¬æŒ‰é’®ï¼ˆé¡¶éƒ¨å’Œåº•éƒ¨ï¼‰çš„äº‹ä»¶å¤„ç†
        document.getElementById('to-bottom-button').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('bottom-of-page').scrollIntoView({
                behavior: 'smooth'
            });
        });
        document.getElementById('to-top-button').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('top-of-page').scrollIntoView({
                behavior: 'smooth'
            });
        });

        // è½¬ä¹‰HTMLå­—ç¬¦ä¸²ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å½±å“é¡µé¢
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(match) {
                switch (match) {
                    case '&':
                        return '&amp;';
                    case '<':
                        return '&lt;';
                    case '>':
                        return '&gt;';
                    case '"':
                        return '&quot;';
                    case "'":
                        return '&#39;';
                }
            });
        }
        //æ‰¹é‡åˆ é™¤
        document.getElementById('batchDeleteBtn').addEventListener('click', function() {
            if (selectedQuestionOrder.length === 0) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„é¢˜ç›®ï¼');
                return;
            }
        
            if (!confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„é¢˜ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
        
            fetch('/api/questions/batch_delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question_ids: selectedQuestionOrder }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`åˆ é™¤å¤±è´¥ï¼š${data.error}`);
                } else {
                    alert(data.message);
                    
                    // æ‰¹é‡åˆ é™¤åæ¸…ç©ºé€‰ä¸­çŠ¶æ€
                    selectedQuestionOrder = [];
                    updateSelectedQuestionIds();
                    
                    // é‡æ–°åŠ è½½å½“å‰é¡µ
                    loadQuestions(currentPage);
                }
            })
            .catch(error => {
                console.error('æ‰¹é‡åˆ é™¤å‡ºé”™:', error);
                alert('æ‰¹é‡åˆ é™¤å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ï¼');
            });
        });

        // é«˜äº®æ˜¾ç¤ºé€‰ä¸­çš„é¢˜ç›®è¡Œ
        function toggleHighlight(row, questionId) {
            document.querySelectorAll('.highlighted').forEach(function(r) {
                r.classList.remove('highlighted');
            });
            row.classList.add('highlighted');
            highlightedRowId = questionId;
        }

        //éš¾æ˜“åº¦è¯´æ˜
        function openPopup(x) {
            if (x == 0) alert("éš¾æ˜“åº¦ç­‰çº§1-5çº§ï¼š\n  1çº§ï¼šå•çº¯çš„çŸ¥è¯†æ€§è€ƒå¯Ÿ\n  2çº§ï¼šæ—¥å¸¸çš„åº”ç”¨ï¼Œåˆæ­¥çš„ç†è§£ï¼Œç®€å•çš„é€»è¾‘\n  3çº§ï¼šç¨å¤æ‚çš„é€»è¾‘ï¼ŒåŸç†æ€§çš„ç†è§£\n  4çº§ï¼šå¯¹è§£å†³ç”Ÿæ´»ä¸­ä¸€èˆ¬é—®é¢˜èƒ½åŠ›çš„è€ƒå¯Ÿï¼Œæˆ–è¾ƒå¼ºé€»è¾‘æ¨æ¼”èƒ½åŠ›çš„è€ƒå¯Ÿ\n  5çº§ï¼šå¯¹è§£å†³ç”Ÿæ´»ä¸­å¤æ‚é—®é¢˜èƒ½åŠ›çš„è€ƒå¯Ÿï¼Œè€ƒå¯Ÿå½¢å¼å¤šæ ·åŒ–ï¼Œéœ€æå¼ºçš„ä¿¡æ¯æ„è¯†ä¸é€»è¾‘èƒ½åŠ›ï¼Œä¸€èˆ¬ä¸ºpythonå‹è½´å¤§é¢˜ã€‚\n");
            else if (x == 1) alert("1.é»˜è®¤æ¨¡ç³ŠåŒ¹é…ï¼Œæ¥å—ç©ºæ ¼ã€æ ‡ç‚¹ç­‰åå·®\n2.ç²¾ç¡®æŸ¥è¯¢ï¼šæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼Œéœ€å®Œå…¨åŒ¹é…\n3.æ­¤é¡¹æœç´¢èŒƒå›´åŒ…æ‹¬é¢˜ç›®æ–‡æœ¬ã€ç­”æ¡ˆã€è§£æ");
            else if (x == 2) alert("ä½¿ç”¨è‹±æ–‡é€—å·åˆ†éš”å°†æ˜¾ç¤ºå¤šé¢˜");
        }
        //çŸ¥è¯†ç‚¹èœå•
        $(document).ready(function () {
            $.ajax({
                url: '/api/knowledgepoints',
                type: 'GET',
                success: function (modules) {
                    // åŠ¨æ€æ·»åŠ  'æ·»åŠ çŸ¥è¯†ç‚¹' è¡¨å•
                    var formHtml = `
                        <div style="display: flex; align-items: center;">
                            <form id="add-knowledgepoint-form" style="display: flex">
                                <input type="text" class="form-control" id="newModule" name="module" placeholder="æ¨¡å—" style="width: 150px; margin-right: 10px;">
                                <input type="text" class="form-control" id="newKnowledgePoint" name="knowledgepoint" placeholder="çŸ¥è¯†ç‚¹" style="width: 150px; margin-right: 10px;">
                                <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                            </form>
                        </div>`;
                    $('#knowledge-points').append(formHtml);
        
                    var bgClasses = ['bg-primary', 'bg-warning', 'bg-success', 'bg-info'];
                    modules.forEach(function (module, index) {
                        var bgClass = bgClasses[index % bgClasses.length];
                        $('#knowledge-points').append(`<p class="badge ${bgClass} m-1">${module.module}</p>`);
        
                        // ä¸ºæ¯ä¸ªçŸ¥è¯†ç‚¹ç”Ÿæˆå¯ç‚¹å‡»çš„æ ‡ç­¾
                        module.knowledgepoints.forEach(function (kp) {
                            $('#knowledge-points').append(`
                                <span class="badge bg-secondary m-1 knowledge-tag" 
                                      data-knowledge="${kp.knowledgepoint}" 
                                      onclick="toggleKnowledgePoint(this)">
                                    ${kp.knowledgepoint}
                                </span>`);
                        });
                        $('#knowledge-points').append('<br>');
                    });
        
                    $('#knowledge-points').append('<input type="text" class="form-control" id="knowledgePoint" name="knowledge_point" hidden>');
        
                    // å¤„ç†è¡¨å•æäº¤
                    $('#add-knowledgepoint-form').submit(function (event) {
                        event.preventDefault();
                        var newModule = $('#newModule').val().trim();
                        var newKnowledgePoint = $('#newKnowledgePoint').val().trim();
                        if (newModule && newKnowledgePoint) {
                            $.ajax({
                                url: '/api/add_knowledgepoint',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    module: newModule,
                                    knowledgepoint: newKnowledgePoint
                                }),
                                success: function (response) {
                                    alert('çŸ¥è¯†ç‚¹æ·»åŠ æˆåŠŸ');
                                    window.location.reload();
                                },
                                error: function (response) {
                                    alert('æ·»åŠ çŸ¥è¯†ç‚¹å¤±è´¥: ' + response.responseText);
                                }
                            });
                        } else {
                            alert('è¯·å¡«å†™å®Œæ•´çš„æ¨¡å—å’ŒçŸ¥è¯†ç‚¹');
                        }
                    });
                },
                error: function (error) {
                    console.log(error);
                }
            });
        });
        
        // ç¼–è¾‘æ¨¡æ€æ¡†æ–°å¢åŠ çš„çŸ¥è¯†ç‚¹æ ‡ç­¾ç›¸å…³ä»£ç 
        function loadKnowledgePointsForEditModal() {
            $.ajax({
                url: '/api/knowledgepoints',
                type: 'GET',
                success: function (modules) {
                    $('#edit-knowledge-points').empty();
                    var bgClasses = ['bg-primary', 'bg-warning', 'bg-success', 'bg-info'];
                    modules.forEach(function (module, index) {
                        var bgClass = bgClasses[index % bgClasses.length];
                        $('#edit-knowledge-points').append(`<p class="badge ${bgClass} m-1">${module.module}</p>`);
                        module.knowledgepoints.forEach(function (kp) {
                            $('#edit-knowledge-points').append(`
                                <span class="badge bg-secondary m-1 edit-knowledge-tag" data-knowledge="${kp.knowledgepoint}" onclick="toggleEditKnowledgePoint(this)">
                                    ${kp.knowledgepoint}
                                </span>`);
                        });
                        $('#edit-knowledge-points').append('<br>');
                    });
                    $('#edit-knowledge-points').append('<input type="text" class="form-control" id="editKnowledgePointHidden" name="editknowledge_point" hidden>');
                    // æ ¹æ®å½“å‰é¢˜ç›®çš„çŸ¥è¯†ç‚¹è‡ªåŠ¨æ ‡è®°
                    const question = questions.find(q => q.id === editingQuestionId);
                    if (question && question.knowledge_point) {
                        const selected = question.knowledge_point.split('|').map(s => s.trim());
                        document.getElementById('editKnowledgePointHidden').value = selected.join('|');
                        $('#edit-knowledge-points span.edit-knowledge-tag').each(function(){
                            let kp = $(this).data('knowledge');
                            if (selected.indexOf(kp) !== -1) {
                                $(this).removeClass('bg-secondary').addClass('bg-danger');
                            }
                        });
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }
        function toggleEditKnowledgePoint(element) {
            const hiddenInput = document.getElementById('editKnowledgePointHidden');
            let selectedKnowledge = element.dataset.knowledge;
            let currentKnowledge = hiddenInput.value ? hiddenInput.value.split('|') : [];
            if (currentKnowledge.includes(selectedKnowledge)) {
                currentKnowledge = currentKnowledge.filter(k => k !== selectedKnowledge);
                $(element).removeClass('bg-danger').addClass('bg-secondary');
            } else {
                currentKnowledge.push(selectedKnowledge);
                $(element).removeClass('bg-secondary').addClass('bg-danger');
            }
            hiddenInput.value = currentKnowledge.join('|');
        }
        
        // è´Ÿè´£çŸ¥è¯†ç‚¹é€‰æ‹©å’Œå–æ¶ˆé€‰æ‹©
        function toggleKnowledgePoint(element) {
            const knowledgeInput = document.getElementById('knowledgePoint');
            const selectedKnowledge = element.dataset.knowledge;
        
            let currentKnowledge = knowledgeInput.value ? knowledgeInput.value.split('|') : [];
        
            if (currentKnowledge.includes(selectedKnowledge)) {
                // å¦‚æœå·²å­˜åœ¨ï¼Œåˆ™ç§»é™¤
                currentKnowledge = currentKnowledge.filter(k => k !== selectedKnowledge);
                $(element).removeClass('bg-danger').addClass('bg-secondary');
            } else {
                // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ 
                currentKnowledge.push(selectedKnowledge);
                $(element).removeClass('bg-secondary').addClass('bg-danger');
            }
        
            // æ›´æ–°éšè—è¾“å…¥æ¡†çš„å€¼
            knowledgeInput.value = currentKnowledge.join('|');
        }

        //GPTè§£æç”Ÿæˆ
        // å®ç°å¸¦æœ‰è¶…æ—¶åŠŸèƒ½çš„ fetch
        function fetchWithTimeout(url, options, timeout = 600000) { // é»˜è®¤è¶…æ—¶60ç§’
            return new Promise((resolve, reject) => {
                const timer = setTimeout(() => {
                    reject(new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•ã€‚'));
                }, timeout);
        
                fetch(url, options)
                    .then(response => {
                        clearTimeout(timer);
                        resolve(response);
                    })
                    .catch(err => {
                        clearTimeout(timer);
                        reject(err);
                    });
            });
        }

        function generateAnalysis(contentbox, answerbox, resbox) {
            const content = document.getElementById(contentbox).value;
            const answer = document.getElementById(answerbox).value;
            const mode = document.getElementById("analysisMode").value;  // è·å–é€‰ä¸­çš„æ¨¡å¼
            const customPrompt = document.getElementById("customPrompt").value;  // è·å–è‡ªå®šä¹‰prompt
        
            // æ£€æŸ¥é¢˜ç›®æ˜¯å¦ä¸ºç©º
            if (content.trim() === '') {
                alert('é¢˜ç›®ä¸ºç©º');
                return; // æå‰é€€å‡ºå‡½æ•°
            }
        
            // æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦ä¸ºç©º
            if (answer.trim() === '') {
                const userConfirmed = confirm('ç­”æ¡ˆä¸ºç©ºå¯èƒ½ä¼šå¯¼è‡´æ­£ç¡®æ€§ä¸è¶³ï¼Œç¡®å®šå—ï¼Ÿ');
                if (!userConfirmed) {
                    return; // ç”¨æˆ·é€‰æ‹©å–æ¶ˆï¼Œæå‰é€€å‡ºå‡½æ•°
                }
            }
        
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            $(resbox).summernote('code', 'ç”Ÿæˆä¸­...');
            // ç¦ç”¨æäº¤æŒ‰é’®ï¼ˆå‡è®¾æœ‰ä¸€ä¸ªæäº¤æŒ‰é’®ï¼‰
            const submitButton = document.getElementById('submit-button');
            if (submitButton) submitButton.disabled = true;
        
            fetchWithTimeout(`/generate_analysis/${mode}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content,
                    answer,
                    prompt: customPrompt
                })
            }, 600000) // è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º3åˆ†é’Ÿ
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    //console.error('error:', data.error);
                    //alert(`é”™è¯¯: ${data.error}`);
                    $(resbox).summernote('code', 'ç”Ÿæˆå¤±è´¥ï¼Œæš‚ä¸æ”¯æŒè¯¥æ¨¡å‹ã€‚');
                } else {
                    $(resbox).summernote('code', data.analysis);
                }
            })
            .catch(error => {
                console.error('error:', error);
                //alert(error.message);
                $(resbox).summernote('code', 'è¯·æ±‚è¶…æ—¶æˆ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            })
            .finally(() => {
                // æ¢å¤æäº¤æŒ‰é’®
                if (submitButton) submitButton.disabled = false;
            });
        }
        //htmlæ ¼å¼æ•´ç†
        function html_format(obj) {
            var content = $(obj).summernote('code');
            $(obj).summernote('code', 'æ•´ç†ä¸­...');
            fetch(`/html_format`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content
                })
            }).then(response => response.json()).then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                } else {
                    $(obj).summernote('code', data.result);
                }
            }).catch(error => {
                console.error('Error:', error);
            });
        }
        // é€‰æ‹©é—®é¢˜æ ¼å¼åŒ–
        function choose_format(obj) {
            var content = $(obj).summernote('code');
            $(obj).summernote('code', 'æ•´ç†ä¸­...');
            fetch(`/choose_format`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                    } else {
                        $(obj).summernote('code', data.result);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        //summernoteæ§ä»¶ï¼ˆåŒ…å«å›¾ç‰‡ä¸Šä¼ ï¼‰
        $(document).ready(function() {
            function initializeSummernote(selector) { // åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåˆå§‹åŒ– Summernote ç¼–è¾‘å™¨
                $(selector).summernote({
                    tabDisable: true,
                    fontNames: ['å®‹ä½“', 'Times New Roman', 'é»‘ä½“', 'ä»¿å®‹', 'æ¥·ä½“', 'å¾®è½¯é›…é»‘'],
                    fontNamesIgnoreCheck: ['æ¥·ä½“'],
                    toolbar: [
                        ['style', ['style']],
                        ['font', ['bold', 'italic', 'underline', 'clear', 'borderedText']],
                        ['fontname', ['fontname']],
                        ['color', ['color']],
                        ['para', ['ul', 'ol', 'paragraph']],
                        ['height', ['height']],
                        ['table', ['table']],
                        ['insert', ['link', 'picture', 'video']],
                        ['view', ['fullscreen', 'codeview', 'help']]
                    ],
                    buttons: {
                        borderedText: function(context) {
                            var ui = $.summernote.ui;
                            return ui.button({
                                contents: 'â–£',
                                tooltip: 'å­—ä½“è¾¹æ¡†',
                                click: function() {
                                    // è·å–é€‰ä¸­çš„æ–‡æœ¬å¹¶æ·»åŠ /ç§»é™¤è¾¹æ¡†æ ·å¼
                                    var selectedText = window.getSelection().toString();
                                    if (selectedText) {
                                        context.invoke('editor.pasteHTML', '<span style="border:solid windowtext 1.0pt">' + selectedText + '</span>');
                                    } else {
                                        alert("è¯·å…ˆé€‰æ‹©è¦åº”ç”¨è¾¹æ¡†çš„æ–‡æœ¬");
                                    }
                                }
                            }).render();
                        }
                    },
                    callbacks: {
                        onImageUpload: function(files) {
                            var data = new FormData();
                            data.append('file', files[0]);
                            $.ajax({
                                url: '/upload_image', // ä½ çš„å›¾ç‰‡ä¸Šä¼ æ¥å£
                                method: 'POST',
                                data: data,
                                processData: false,
                                contentType: false,
                                success: function(response) {
                                    // ç¡®ä¿è¿™é‡Œæ­£ç¡®åœ°è·å–äº† URL
                                    var imageUrl = response.url;
                                    if (imageUrl) {
                                        // æ’å…¥å›¾ç‰‡
                                        $(selector).summernote('insertImage', imageUrl);
                                    } else {
                                        console.error('URL æ ¼å¼é”™è¯¯', response);
                                    }
                                },
                                error: function(err) {
                                    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥', err);
                                }
                            });
                        },
                        onEnter: function (e) {
                            // è·å–å½“å‰ç¼–è¾‘åŒºåŸŸ
                            const range = $('#summernote').summernote('createRange');
                            
                            // åˆ›å»ºä¸€ä¸ªæ–°çš„ <div>
                            const newDiv = document.createElement('div');
                            newDiv.innerHTML = '<br>'; // ç¡®ä¿æ–° <div> ä¸­æœ‰å†…å®¹

                            range.collapse(false);
            
                            // æ›´æ–° Summernote çš„é€‰åŒº
                            $('#summernote').summernote('setRange', range);
            
                            // é˜»æ­¢é»˜è®¤è¡Œä¸º
                            return false;
                        }
                    },
                    height: 300, // è®¾ç½®ç¼–è¾‘å™¨é«˜åº¦
                    minHeight: null, // æœ€å°é«˜åº¦
                    maxHeight: null, // æœ€å¤§é«˜åº¦
                });
                //$(selector).summernote('removeModule', 'autoLink'); //è¿™ä¸€æ¨¡å—ä¸­å­˜åœ¨summernoteçš„å¤©ç„¶BUGï¼Œè™½ç„¶é—®é¢˜ä¸å¤§ï¼Œä½†å¦‚æœçœ‹ç€å¿ƒçƒ¦å¯ä»¥å»æ‰è¿™ä¸ªæ¨¡å—
            }
            // ä¸ºæ¯ä¸ªç¼–è¾‘å™¨è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
            initializeSummernote('#content');
            initializeSummernote('#analysis');
            initializeSummernote('#editContent');
            initializeSummernote('#editAnalysis');
        });
        
        // æ§åˆ¶æ‚¬æµ®æ¡†æ˜¾ç¤ºçš„å‡½æ•°
        function togglePromptBox() {
            const overlay = document.getElementById('promptOverlay');
            overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
        }
        // ç‚¹å‡»å¤–éƒ¨å…³é—­æ‚¬æµ®æ¡†
        document.getElementById('promptOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                togglePromptBox();
            }
        });
        
    </script>

    <script src="{{ url_for('static', filename='jquery/jquery-3.6.0.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/5.2.3/bootstrap.min.css') }}">
    <script src="{{ url_for('static', filename='js/4.5.2/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='export_docx/FileSaver.js') }}"></script>
    <script src="{{ url_for('static', filename='export_docx/jquery.wordexport.js') }}"></script>
    <!-- å¼•å…¥Summernote JS æä¾›htmlæ§ä»¶ -->
    <script src="{{ url_for('static', filename='js/summernote-bs5.min.js') }}"></script>
    <!-- å¼•å…¥Summernote CSS -->
    <link href="{{ url_for('static', filename='css/summernote-bs5.min.css') }}" rel="stylesheet">

    {% endblock %}
</body>

</html>
