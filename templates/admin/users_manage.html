<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>用户管理</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/5.2.3/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='css/index.css') }}">
</head>

<body>

    {% extends 'header.html' %}
    {% block content %}

    <div class="container mt-5">
        <h1>用户管理</h1>
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" id="searchInput" class="form-control" placeholder="查找用户..." onkeyup="searchUsers()">
            </div>
        </div>
        <button class="btn btn-primary mb-3" onclick="showAddUserModal()">添加用户</button>
        <button class="btn btn-warning mb-3" onclick="window.location.href='/upload_users'">批量导入</button>
        <button class="btn btn-danger mb-3" onclick="batchDeleteUsers()">批量删除</button>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
                    </th>
                    <th>序号</th>
                    <th>用户名</th>
                    <th>昵称</th>
                    <th>邮箱</th>
                    <th>班级</th>
                    <th>身份</th>
                    <th>GPT次数</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <!-- User rows will be appended here -->
            </tbody>
        </table>

        <div id="pagination" class="mt-3">
            <!-- Pagination buttons will be appended here -->
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" role="dialog" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">添加用户</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="form-group">
                            <label for="username">用户名</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="form-group">
                            <label for="usernick">昵称</label>
                            <input type="text" class="form-control" id="usernick">
                        </div>
                        <div class="form-group">
                            <label for="email">邮箱</label>
                            <input type="text" class="form-control" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="className">班级</label>
                            <input type="text" class="form-control" id="className">
                        </div>
                        <div class="form-group">
                            <label for="role">身份</label>
                            <select class="form-control" id="role">
                                <option value="student">student</option>
                                <option value="teacher">teacher</option>
                                <option value="admin">admin</option>
                                <option value="user">user</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="password">密码</label>
                            <input type="password" class="form-control" id="password">
                        </div>
                        <div class="form-group">
                            <label for="request_count">GPT已使用</label>
                            <input type="text" class="form-control" id="request_count">
                        </div>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='jquery/3.5.1/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/4.5.2/bootstrap.bundle.min.js') }}"></script>
    <script>
        $(document).ready(function() {
            loadUsers();
        
            $('#userForm').on('submit', function(e) {
                e.preventDefault();
                saveUser();
            });
        
            // 当单个用户复选框变化时，同步全选复选框状态
            $(document).on('change', '.user-checkbox', function () {
                syncSelectAllCheckbox();
            });
        });

        let currentPage = 1;
        const perPage = 100;
        let searchQuery = '';

        function loadUsers(page = 1, search = '') {
            $.ajax({
                url: `/users?page=${page}&per_page=${perPage}&search=${search}`,
                method: 'GET',
                success: function(data) {
                    let userTableBody = $('#userTableBody');
                    userTableBody.empty();
                    data.users.forEach(user => {
                        let row = `
                        <tr>
                            <td>
                                <input type="checkbox" class="user-checkbox" value="${user.id}">
                            </td>
                            <td>${user.id}</td>
                            <td>
                                <a href="/student/analysis/${user.id}" style="text-decoration: none;">${user.username}
                                    <div class="avatar-group">
                                        <img src="${user.avatar_url}" alt="用户头像" class="avatar">
                                    </div>
                                </a>
                            </td>
                            <td>${user.usernick}</td>
                            <td>${user.email}</td>
                            <td>${user.class_name || ''}</td>
                            <td>${user.role}</td>
                            <td>${user.request_count}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="showEditUserModal(${user.id})">编辑</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">删除</button>
                            </td>
                        </tr>
                        `;
                        userTableBody.append(row);
                    });

                    // 更新分页按钮
                    updatePagination(data.pages, data.current_page);
                },
                error: function(xhr) {
                    console.error('获取用户列表失败', xhr);
                    alert('获取用户列表失败，请查看控制台以获取更多信息。');
                }
            });
        }
        function toggleSelectAll(checkbox) {
            const checked = checkbox.checked;
            $('.user-checkbox').prop('checked', checked);
        }
        
        function syncSelectAllCheckbox() {
            const total = $('.user-checkbox').length;
            const checked = $('.user-checkbox:checked').length;
            $('#selectAll').prop('checked', total > 0 && total === checked);
        }
        function updatePagination(totalPages, currentPage) {
            let paginationContainer = $('#pagination');
            paginationContainer.empty();

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                let pageButton = `<button class="btn btn-sm btn-secondary ${i === currentPage ? 'active' : ''}" onclick="loadUsers(${i}, searchQuery)">${i}</button>`;
                paginationContainer.append(pageButton);
            }
        }

        function searchUsers() {
            searchQuery = $('#searchInput').val(); // 获取搜索框中的值
            loadUsers(1, searchQuery); // 重新加载第 1 页，并附带搜索关键字
        }

        function showAddUserModal() {
            $('#userForm')[0].reset();
            $('#userId').val('');
            $('#userModalLabel').text('添加用户');
            $('#userModal').modal('show');
        }

        function showEditUserModal(userId) {
            $.ajax({
                url: `/user/${userId}`,
                method: 'GET',
                success: function(user) {
                    $('#userId').val(user.id);
                    $('#username').val(user.username);
                    $('#usernick').val(user.usernick);
                    $('#email').val(user.email);
                    $('#className').val(user.class_name || '');
                    $('#role').val(user.role);
                    $('#request_count').val(user.request_count);
                    $('#password').val(''); // Password field is required but won't be updated unless specified
                    $('#userModalLabel').text('编辑用户');
                    $('#userModal').modal('show');
                }
            });
        }

        function saveUser() {
            let userId = $('#userId').val();
            let url = userId ? `/user/${userId}` : '/user';
            let method = userId ? 'PUT' : 'POST';
            let userData = {
                username: $('#username').val(),
                usernick: $('#usernick').val(),
                email: $('#email').val(),
                class_name: $('#className').val(),
                role: $('#role').val(),
                password: $('#password').val(),
                request_count: $('#request_count').val()
            };

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(userData),
                success: function(response) {
                    $('#userModal').modal('hide');
                    loadUsers();
                    alert(response.message);
                },
                error: function(xhr) {
                    alert(xhr.responseJSON.message);
                }
            });
        }

        function deleteUser(userId) {
            if (confirm('确定删除吗?')) {
                $.ajax({
                    url: `/user/${userId}`,
                    method: 'DELETE',
                    success: function(response) {
                        loadUsers();
                        alert(response.message);
                    }
                });
            }
        }
        function batchDeleteUsers() {
            // 获取所有被选中的用户id
            let selectedIds = [];
            $('.user-checkbox:checked').each(function() {
                selectedIds.push(parseInt($(this).val()));
            });
        
            if (selectedIds.length === 0) {
                alert('请先选择要删除的用户');
                return;
            }
        
            if (!confirm(`确定要删除选中的 ${selectedIds.length} 个用户吗？关联的签到、考试记录也会被删除！`)) {
                return;
            }
        
            $.ajax({
                url: '/users/batch_delete',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ user_ids: selectedIds }),
                success: function(response) {
                    alert(response.message);
                    // 删除后重新加载当前页
                    loadUsers(currentPage, searchQuery);
                    // 清除全选框状态
                    $('#selectAll').prop('checked', false);
                },
                error: function(xhr) {
                    const res = xhr.responseJSON || {};
                    alert(res.message || res.error || '批量删除失败');
                }
            });
        }
    </script>

    {% endblock %}
</body>

</html>