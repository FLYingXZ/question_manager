{% extends 'header.html' %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <title>HTML Editor</title>
</head>
<body>
    <div class="container mt-5">
        <h1>HTML 文件编辑器</h1>
        <div id="content"></div>
        <button id="confirmDownload" class="btn btn-primary mt-3">导出为 Word</button>
    </div>

    <script src="{{ url_for('static', filename='jquery/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/4.5.2/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='export_docx/FileSaver.js') }}"></script>
    <script src="{{ url_for('static', filename='export_docx/jquery.wordexport.js') }}"></script>
    <script src="{{ url_for('static', filename='js/summernote-bs5.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/5.2.3/bootstrap.min.css') }}">
    <link href="{{ url_for('static', filename='css/summernote-bs5.min.css') }}" rel="stylesheet">

    <script>
        $(document).ready(function() {
            $('#content').summernote({
                tabDisable: true,
                fontNames: ['宋体', 'Times New Roman', '黑体', '仿宋', '楷体', '微软雅黑'],
                fontNamesIgnoreCheck: ['楷体'],
                toolbar: [
                    
                    ['font', ['bold', 'italic', 'underline', 'clear', 'borderedText']],
                    ['fontname', ['fontname']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['height', ['height']],
                    ['table', ['table']],
                    ['insert', ['link', 'picture', 'video']],
                    ['view', ['fullscreen', 'codeview', 'help']]
                ],
                buttons: {
                        borderedText: function(context) {
                            var ui = $.summernote.ui;
                            return ui.button({
                                contents: '▣',
                                tooltip: '字体边框',
                                click: function() {
                                    // 获取选中的文本并添加/移除边框样式
                                    var selectedText = window.getSelection().toString();
                                    if (selectedText) {
                                        context.invoke('editor.pasteHTML', '<span style="border:solid windowtext 1.0pt">' + selectedText + '</span>');
                                    } else {
                                        alert("请先选择要应用边框的文本");
                                    }
                                }
                            }).render();
                        }
                    },
                callbacks: {
                    onImageUpload: function(files) {
                        var data = new FormData();
                        data.append('file', files[0]);
                        $.ajax({
                            url: '/upload_image',
                            method: 'POST',
                            data: data,
                            processData: false,
                            contentType: false,
                            success: function(response) {
                                var imageUrl = response.url;
                                $('#content').summernote('insertImage', imageUrl);
                            },
                            error: function(err) {
                                console.error('图片上传失败', err);
                            }
                        });
                    }
                },
                height: 300
            });

            document.getElementById('confirmDownload').addEventListener('click', function() {
                let htmlContent = $('#content').summernote('code');
                const container = document.createElement('div');
                container.innerHTML = htmlContent;
                document.body.appendChild(container);

                const images = container.querySelectorAll('img');
                let imagePromises = [];
                images.forEach(img => {
                    imagePromises.push(convertImageToBase64(img));
                });

                Promise.all(imagePromises).then(() => {
                    $(container).wordExport('EditedContent');
                    document.body.removeChild(container);
                });
            });
        });

        // 图片转 Base64 的函数，返回 Promise 确保转换完成
        function convertImageToBase64(imgElement) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.src = imgElement.src;

                img.onload = function () {
                    const canvas = document.createElement("canvas");
                    // 使用 imgElement 的宽高来调整导出大小
                    canvas.width = imgElement.width;
                    canvas.height = imgElement.height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, imgElement.width, imgElement.height);
        
                    imgElement.src = canvas.toDataURL("image/png");
                    imgElement.style.width = `${imgElement.width}px`;
                    imgElement.style.height = `${imgElement.height}px`;
                    resolve(); // 完成转换
                };
    
                img.onerror = reject;
            });
        }
    </script>
    
</body>
{% endblock %}