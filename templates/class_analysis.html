<title>班级成绩概览 - {{ class_.name }}</title>
{% extends "header.html" %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/5.2.3/bootstrap.min.css') }}">

<style>
  .page-wrap { padding: 18px 18px 8px; }
  .page-title {
    display:flex; align-items:flex-end; justify-content:space-between;
    gap: 12px; padding: 6px 4px 2px;
  }
  .page-title h2 { margin: 0; font-weight: 700; color:#2c3e50; }
  .subtle { color:#7f8c8d; font-size: 13px; }

  .kpi-card {
    border: 1px solid #e7edf3;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,.05);
    background: #fff;
  }
  .kpi {
    padding: 14px 14px;
    border-right: 1px dashed #e9eef4;
  }
  .kpi:last-child { border-right: none; }
  .kpi .label { font-size: 12px; color:#7f8c8d; }
  .kpi .value { font-size: 22px; font-weight: 800; color:#2c3e50; line-height: 1.2; }
  .kpi .hint { font-size: 12px; color:#95a5a6; margin-top: 2px; }

  .panel {
    border: 1px solid #e7edf3;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,.05);
    overflow: hidden;
    background: #fff;
  }
  .panel-hd {
    padding: 12px 14px;
    background: linear-gradient(180deg, #f7fbff, #ffffff);
    border-bottom: 1px solid #eef3f7;
    display:flex; align-items:center; justify-content:space-between; gap: 10px;
  }
  .panel-hd h5 { margin: 0; font-weight: 700; color:#2c3e50; }
  .panel-bd { padding: 14px; }

  .badge-soft {
    background: rgba(52,152,219,.12);
    color:#2980b9;
    border: 1px solid rgba(52,152,219,.25);
    font-weight: 600;
  }
  .table thead th {
    white-space: nowrap;
    background: #f8fafc;
    border-bottom: 1px solid #eaeef3;
    color:#34495e;
    font-weight: 700;
  }
  .table tbody tr:hover { background: #f7fbff; }
  .student-link { color:#2c3e50; font-weight: 600; text-decoration:none; }
  .student-link:hover { color:#3498db; text-decoration: underline; }

  .sortable { cursor:pointer; user-select:none; }
  .sort-icon { margin-left:6px; color:#95a5a6; }
  .sortable.asc .sort-icon, .sortable.desc .sort-icon { color:#3498db; }

  .mini-list li { margin: 6px 0; display:flex; justify-content:space-between; gap: 12px; }
  .mini-list .name { color:#2c3e50; font-weight: 600; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 68%; }
  .mini-list .num { color:#34495e; font-weight: 800; }

  .chart-box { height: 290px; }
  @media (max-width: 992px) { .chart-box { height: 260px; } }
</style>

<div class="page-wrap">
  <div class="page-title">
    <div>
      <h2>{{ class_.name }} 班级成绩概览</h2>
      <div class="subtle">点击学生姓名进入个人分析；支持排序与搜索过滤</div>
    </div>

    <div class="d-flex gap-2">
      <span class="badge badge-soft rounded-pill px-3 py-2">
        <i class="fa-solid fa-users me-1"></i> 学生：{{ student_scores|length }}
      </span>
      <span class="badge badge-soft rounded-pill px-3 py-2">
        <i class="fa-solid fa-chart-line me-1"></i> 班均：{{ class_avg }}
      </span>
    </div>
  </div>

  {# ===== 计算一些统计值（Jinja 侧） ===== #}
  {% set n = student_scores|length %}
  {% set max_avg = (student_scores|max(attribute='avg_score')).avg_score if student_scores else 0 %}
  {% set min_avg = (student_scores|min(attribute='avg_score')).avg_score if student_scores else 0 %}

  {# 分段统计（按平均分） #}
  {% set ns = namespace(a90=0,a80=0,a70=0,a60=0,a0=0) %}
  {% for s in student_scores %}
    {% if s.avg_score >= 90 %}{% set ns.a90 = ns.a90 + 1 %}
    {% elif s.avg_score >= 80 %}{% set ns.a80 = ns.a80 + 1 %}
    {% elif s.avg_score >= 70 %}{% set ns.a70 = ns.a70 + 1 %}
    {% elif s.avg_score >= 60 %}{% set ns.a60 = ns.a60 + 1 %}
    {% else %}{% set ns.a0 = ns.a0 + 1 %}
    {% endif %}
  {% endfor %}

  {# ===== KPI 卡片 ===== #}
  <div class="kpi-card mt-3">
    <div class="row g-0">
      <div class="col-6 col-lg-3 kpi">
        <div class="label"><i class="fa-solid fa-layer-group me-1"></i>班级平均分</div>
        <div class="value">{{ class_avg }}</div>
        <div class="hint">整体水平参考</div>
      </div>
      <div class="col-6 col-lg-3 kpi">
        <div class="label"><i class="fa-solid fa-trophy me-1"></i>最高平均分</div>
        <div class="value">{{ max_avg }}</div>
        <div class="hint">平均分最高的学生</div>
      </div>
      <div class="col-6 col-lg-3 kpi">
        <div class="label"><i class="fa-solid fa-arrow-down-wide-short me-1"></i>最低平均分</div>
        <div class="value">{{ min_avg }}</div>
        <div class="hint">需重点关注</div>
      </div>
      <div class="col-6 col-lg-3 kpi">
        <div class="label"><i class="fa-solid fa-chart-pie me-1"></i>达标率(≥60)</div>
        <div class="value">
          {% if n > 0 %}
            {{ (((n - ns.a0) / n) * 100) | round(1) }}%
          {% else %}0%{% endif %}
        </div>
        <div class="hint">按“平均分”粗略计算</div>
      </div>
    </div>
  </div>

  {# ===== 图表 & 分析区 ===== #}
  <div class="row mt-3 g-3">
    <div class="col-12 col-lg-7">
      <div class="panel">
        <div class="panel-hd">
          <h5><i class="fa-solid fa-chart-column me-2"></i>平均分分布（人数）</h5>
          <span class="subtle">90+/80+/70+/60+/不及格</span>
        </div>
        <div class="panel-bd">
          <div class="chart-box">
            <canvas id="distChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="panel h-100">
        <div class="panel-hd">
          <h5><i class="fa-solid fa-ranking-star me-2"></i>Top / Bottom（按平均分）</h5>
          <span class="subtle">快速定位</span>
        </div>
        <div class="panel-bd">
          {% set sorted_by_avg = student_scores|sort(attribute='avg_score', reverse=true) %}
          <div class="row g-3">
            <div class="col-12 col-md-6 col-lg-12 col-xl-6">
              <div class="fw-bold mb-2 text-success">Top 5</div>
              <ul class="list-unstyled mini-list mb-0">
                {% for s in sorted_by_avg[:5] %}
                  <li>
                    <span class="name">
                      <a class="student-link" href="{{ url_for('student_analysis', student_id=s.id) }}">{{ s.name }}</a>
                    </span>
                    <span class="num">{{ s.avg_score }}</span>
                  </li>
                {% endfor %}
                {% if sorted_by_avg|length == 0 %}
                  <li class="subtle">暂无数据</li>
                {% endif %}
              </ul>
            </div>
            <div class="col-12 col-md-6 col-lg-12 col-xl-6">
              <div class="fw-bold mb-2 text-danger">Bottom 5</div>
              <ul class="list-unstyled mini-list mb-0">
                {% for s in (student_scores|sort(attribute='avg_score'))[:5] %}
                  <li>
                    <span class="name">
                      <a class="student-link" href="{{ url_for('student_analysis', student_id=s.id) }}">{{ s.name }}</a>
                    </span>
                    <span class="num">{{ s.avg_score }}</span>
                  </li>
                {% endfor %}
                {% if student_scores|length == 0 %}
                  <li class="subtle">暂无数据</li>
                {% endif %}
              </ul>
            </div>
          </div>

          <hr class="my-3">

          <div class="row g-2">
            <div class="col-6">
              <div class="subtle">≥90</div>
              <div class="fw-bold">{{ ns.a90 }} 人</div>
            </div>
            <div class="col-6">
              <div class="subtle">80-89</div>
              <div class="fw-bold">{{ ns.a80 }} 人</div>
            </div>
            <div class="col-6">
              <div class="subtle">70-79</div>
              <div class="fw-bold">{{ ns.a70 }} 人</div>
            </div>
            <div class="col-6">
              <div class="subtle">60-69</div>
              <div class="fw-bold">{{ ns.a60 }} 人</div>
            </div>
            <div class="col-12">
              <div class="subtle">&lt;60</div>
              <div class="fw-bold">{{ ns.a0 }} 人</div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="col-12 col-lg-7">
      <div class="panel">
        <div class="panel-hd">
          <h5><i class="fa-solid fa-bars-staggered me-2"></i>平均分排行榜（条形图）</h5>
          <span class="subtle">按平均分降序</span>
        </div>
        <div class="panel-bd">
          <div class="chart-box">
            <canvas id="rankBarChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="panel">
        <div class="panel-hd">
          <h5><i class="fa-solid fa-braille me-2"></i>平均分 vs 考试次数（散点）</h5>
          <span class="subtle">观察稳定性/练习量</span>
        </div>
        <div class="panel-bd">
          <div class="chart-box">
            <canvas id="scatterChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# ===== 表格区 ===== #}
  <div class="panel mt-3">
    <div class="panel-hd">
      <h5><i class="fa-solid fa-table me-2"></i>学生明细</h5>
      <div class="d-flex gap-2 align-items-center">
        <div class="input-group input-group-sm" style="width: 260px;">
          <span class="input-group-text bg-white"><i class="fa-solid fa-magnifying-glass"></i></span>
          <input id="tableSearch" type="text" class="form-control" placeholder="搜索学生姓名...">
        </div>
      </div>
    </div>

    <div class="panel-bd">
      <div class="table-responsive">
        <table class="table table-hover align-middle" id="classTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="rank">排名 <i class="fas fa-sort sort-icon"></i></th>
              <th>学生姓名</th>
              <th class="sortable" data-sort="avg">平均分 <i class="fas fa-sort sort-icon"></i></th>
              <th class="sortable" data-sort="count">考试次数 <i class="fas fa-sort sort-icon"></i></th>
              <th class="sortable" data-sort="latest">最近考试分数 <i class="fas fa-sort sort-icon"></i></th>
            </tr>
          </thead>
          <tbody>
            {% for student in student_scores %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>
                <a class="student-link" href="{{ url_for('student_analysis', student_id=student.id) }}">
                  {{ student.name }}
                </a>
              </td>
              <td>{{ student.avg_score }}</td>
              <td>{{ student.exam_count }}</td>
              <td>{{ student.latest_score }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="subtle mt-2">
        提示：点击表头可排序；排序后排名会自动重排。
      </div>
    </div>
  </div>
</div>

<!-- Chart.js（如需本地化请改为 static 引用） -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
$(document).ready(function() {

  // ===== 表格排序 =====
  function getCellValue(row, index) {
    return $(row).children('td').eq(index).text().trim();
  }

  function updateRank(table){
    table.find('tbody > tr:visible').each(function(i){
      $(this).find('td:first').text(i + 1);
    });
  }

  $('.sortable').click(function() {
    const table = $(this).closest('table');
    const rows = table.find('tbody > tr').get();
    const colIndex = $(this).index();
    const isAsc = $(this).hasClass('asc');

    // 清理其他列状态
    $(this).siblings('.sortable').removeClass('asc desc')
      .find('i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');

    // 当前列切换
    $(this).toggleClass('asc', !isAsc).toggleClass('desc', isAsc);
    $(this).find('i').removeClass('fa-sort').toggleClass('fa-sort-up', !isAsc).toggleClass('fa-sort-down', isAsc);

    rows.sort(function(a, b) {
      const aVal = getCellValue(a, colIndex);
      const bVal = getCellValue(b, colIndex);

      // 排名列：整数
      if (colIndex === 0) return isAsc ? (parseInt(aVal)-parseInt(bVal)) : (parseInt(bVal)-parseInt(aVal));

      // 数值列优先按数字排序，否则按字符串
      const aNum = parseFloat(aVal), bNum = parseFloat(bVal);
      if (!isNaN(aNum) && !isNaN(bNum)) return isAsc ? (aNum-bNum) : (bNum-aNum);
      return isAsc ? aVal.localeCompare(bVal, 'zh') : bVal.localeCompare(aVal, 'zh');
    });

    $.each(rows, function(_, row) {
      table.children('tbody').append(row);
    });

    updateRank(table);
  });

  // ===== 搜索过滤 =====
  $('#tableSearch').on('input', function(){
    const q = $(this).val().trim().toLowerCase();
    const table = $('#classTable');
    table.find('tbody > tr').each(function(){
      const name = $(this).find('td').eq(1).text().trim().toLowerCase();
      $(this).toggle(name.indexOf(q) !== -1);
    });
    updateRank(table);
  });

  // ===== 图表数据（从 Jinja 注入）=====
  const dist = {
    labels: ['90+', '80-89', '70-79', '60-69', '<60'],
    values: [{{ ns.a90 }}, {{ ns.a80 }}, {{ ns.a70 }}, {{ ns.a60 }}, {{ ns.a0 }}]
  };

  // 排名条形图：取平均分降序（过多会挤，默认展示前20）
  const rawStudents = [
    {% for s in student_scores %}
      { name: {{ s.name|tojson }}, avg: Number({{ s.avg_score }}), count: Number({{ s.exam_count }}), latest: Number({{ s.latest_score }}) },
    {% endfor %}
  ];

  const sorted = rawStudents.slice().sort((a,b)=>b.avg-a.avg);
  const topN = sorted.slice(0, Math.min(20, sorted.length));

  // ===== 分布图 =====
  new Chart(document.getElementById('distChart'), {
    type: 'bar',
    data: {
      labels: dist.labels,
      datasets: [{
        label: '人数',
        data: dist.values,
        borderWidth: 1,
        backgroundColor: ['#2ecc71','#3498db','#5dade2','#f39c12','#e74c3c'],
        borderColor: ['#27ae60','#2980b9','#2e86c1','#d68910','#c0392b']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: (ctx)=> `人数：${ctx.raw}` } }
      },
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } },
        x: { grid: { display: false } }
      }
    }
  });

  // ===== 平均分排行榜 =====
  new Chart(document.getElementById('rankBarChart'), {
    type: 'bar',
    data: {
      labels: topN.map(s=>s.name),
      datasets: [{
        label: '平均分',
        data: topN.map(s=>s.avg),
        backgroundColor: 'rgba(52, 152, 219, 0.18)',
        borderColor: 'rgba(52, 152, 219, 0.8)',
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { suggestedMin: 0, suggestedMax: 100 },
        y: { grid: { display: false } }
      }
    }
  });

  // ===== 散点：考试次数 vs 平均分 =====
  new Chart(document.getElementById('scatterChart'), {
    type: 'scatter',
    data: {
      datasets: [{
        label: '学生',
        data: rawStudents.map(s=>({ x: s.count, y: s.avg, name: s.name })),
        backgroundColor: 'rgba(46, 204, 113, 0.55)',
        borderColor: 'rgba(39, 174, 96, 0.9)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const p = ctx.raw;
              return `${p.name} | 次数: ${p.x}, 平均分: ${p.y}`;
            }
          }
        }
      },
      scales: {
        x: { title: { display: true, text: '考试次数' }, beginAtZero: true, ticks: { precision: 0 } },
        y: { title: { display: true, text: '平均分' }, suggestedMin: 0, suggestedMax: 100 }
      }
    }
  });

});
</script>

{% endblock %}